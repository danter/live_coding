<html>
  <head>
    <script src="ace-editor/ace.js"></script>
    <style>
      body {
        background-color: #232323;
      }

      .editor {
        height: 600px;
        width: 600px;
      }

      .view {
        width: 800px;
        height: 600px;
        background-color: #141414;
        float: right;
      }

      .container {
        width: 1420px;
      }

      .header {
        color: #aaa;
        margin-bottom: 20px;
      }

      .header h1 {
        font-size: 22px;
        margin-bottom: 5px;
      }
      .header .description, .header .source {
        font-size: 12px;
      }
      .header .source {
        float: right;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header js-header">
        <a href="#" onclick="javascript:document.getElementsByClassName('js-header')[0].style.display='none';" style="float: right">Hide header</a>
        <h1>JavaScript live coding environment</h1>
        <div class="source">You can find the source to this tool at <a href="https://github.com/joakimk/live_coding">github.com/joakimk/live_coding</a>.</div>
        <div class="description">Change the code on the left and see the results right away on the right. Code is saved in your browser's local storage. You can find examples to use as a starting point in <a href="https://github.com/joakimk/live_coding/tree/master/examples">examples/</a>.</div>
      </div>
      <div class="view js-view"></div>
      <div class="editor js-editor">/* jshint asi:true */
view = liveViewElement

// More examples at: https://github.com/joakimk/live_coding/tree/master/examples

model = loadStateOrDefaultTo(300)

main = function() {
  // Always check this in the main loop to stop running old versions of your code!
  if(codeHasChanged()) { return; }

  model += 1
  // model -= 5

  saveState(model)

  view.style.height = model

  view.style.backgroundColor = "purple"
}

setInterval(main, 100)</div>
    </div>

    <script type="text/javascript">
      editorDiv = document.getElementsByClassName("js-editor")[0]
      editor = ace.edit(editorDiv)

      //editor.setTheme("ace/theme/github") // Light theme
      editor.setTheme("ace/theme/twilight") // Dark theme

      // Settings for javascript editing
      editor.setOption("tabSize", 4)
      editor.setOption("useSoftTabs", true)
      editor.session.setMode("ace/mode/javascript")

      editor.session.setUseWrapMode(true)

      // Hide the 80 chars line. No strong reason, mostly because
      // the size of the window is probably a more practical limit for now.
      editor.setShowPrintMargin(false)

      if(window.location.href.indexOf("vim") != -1) {
        editor.setKeyboardHandler("ace/keyboard/vim")
      }

      // Have no looked deeply at this:
      // "Automatically scrolling cursor into view after selection change this will be disabled in the next version set editor.$blockScrolling = Infinity to disable this message"
      editor.$blockScrolling = Infinity

      savedCode = localStorage.getItem("code")
      if(savedCode) {
        console.log("LiveCoding: Loading previously saved code from local storage")
        editor.setValue(savedCode)
        editor.clearSelection()
      }

      editor.gotoLine(1)
      editor.focus()

      runCode = function() {
        code = editor.getValue()

        script = document.createElement("script")
        script.type = "text/javascript"

	localStorage.setItem("code", code)

        window.liveCodeVersion += 1

        script.innerHTML =
          "(function() {" +
	    // Add function that can be used to check if the code is outdated and should stop running.
            "function codeHasChanged() { return " + window.liveCodeVersion + " != window.liveCodeVersion };" +

            // Save and load state to be able to resume the simulation after live code update
            "function saveState(state) { liveCodeState = state };" +
            "function loadStateOrDefaultTo(defaultState) { savedState = window.liveCodeState; return savedState ? savedState : defaultState };" +

            // Load the new version of the code.
            code +

            // Show what version of the code is running now.
            "\nconsole.log('LiveCoding: Code version ' + window.liveCodeVersion + ' loaded successfully!')" +
          "})();"

        document.body.appendChild(script)
      }

      window.liveCodeVersion = 1
      window.liveCodeState = null
      window.liveViewElement = document.getElementsByClassName("js-view")[0]

      editor.on("change", runCode);
      runCode()
    </script>
  </body>
</html>
